#!/usr/bin/env python3

import subprocess
import sys
import os
import re
from datetime import datetime


def run_command(command):
    try:
        output = subprocess.check_output(
            command, shell=True, stderr=subprocess.STDOUT
        )
        return output.decode(errors="ignore")
    except subprocess.CalledProcessError as error:
        return error.output.decode(errors="ignore")


def validate_pdf(pdf_file):
    if not os.path.isfile(pdf_file):
        print("[-] PDF file not found")
        sys.exit(1)


def analyze_metadata(pdf_file):
    return run_command(f"pdfid {pdf_file}")


def analyze_objects(pdf_file):
    return run_command(f"pdf-parser {pdf_file}")


def analyze_javascript(pdf_file):
    return run_command(f"pdf-parser {pdf_file} -s javascript")


def extract_strings(pdf_file):
    return run_command(f"strings {pdf_file}")


def extract_iocs(strings_data):
    urls = re.findall(r"https?://[^\s]+", strings_data)
    ips = re.findall(r"\b(?:\d{1,3}\.){3}\d{1,3}\b", strings_data)
    return list(set(urls)), list(set(ips))


def calculate_risk(metadata, javascript, urls, ips):
    score = 0

    if "/JavaScript" in metadata or "/JS" in metadata:
        score += 2
    if javascript.strip():
        score += 3
    if urls:
        score += 2
    if ips:
        score += 1

    if score >= 5:
        return "HIGH"
    elif score >= 3:
        return "MEDIUM"
    else:
        return "LOW"


def generate_report(pdf_file, results):
    timestamp = datetime.now().strftime("%Y-%m-%d %H:%M")
    report_name = "PDF_Malware_Analysis_Report.txt"

    urls, ips = extract_iocs(results["strings"])
    risk_level = calculate_risk(
        results["metadata"], results["javascript"], urls, ips
    )

    with open(report_name, "w") as report:
        report.write("PDF MALWARE ANALYSIS REPORT\n")
        report.write("=" * 45 + "\n\n")

        report.write(f"Target File   : {pdf_file}\n")
        report.write(f"Analysis Time : {timestamp}\n")
        report.write("Analysis Mode : Static Analysis (No Execution)\n")
        report.write(f"Risk Level    : {risk_level}\n\n")

        report.write("[1] METADATA & KEYWORD ANALYSIS\n")
        report.write(results["metadata"] + "\n\n")

        report.write("[2] OBJECT STRUCTURE ANALYSIS\n")
        report.write(results["objects"] + "\n\n")

        report.write("[3] JAVASCRIPT ANALYSIS\n")
        report.write(results["javascript"] + "\n\n")

        report.write("[4] STRING EXTRACTION\n")
        report.write(results["strings"] + "\n\n")

        report.write("[5] INDICATORS OF COMPROMISE (IOCs)\n")
        if urls:
            report.write("Detected URLs:\n")
            for url in urls:
                report.write(f" - {url}\n")
        else:
            report.write("No suspicious URLs detected\n")

        if ips:
            report.write("\nDetected IP Addresses:\n")
            for ip in ips:
                report.write(f" - {ip}\n")
        else:
            report.write("\nNo suspicious IP addresses detected\n")

        report.write("\n\nFINAL OBSERVATION\n")
        report.write(
            "The PDF file was analyzed using static techniques only. "
            "Detected indicators and the calculated risk level provide "
            "an estimate of potential malicious intent. "
            "The file was not executed during analysis.\n"
        )

    return report_name


def main():
    if len(sys.argv) != 2:
        print("Usage: python3 pdf_malware_analysis_tool.py <pdf_file>")
        sys.exit(1)

    pdf_file = sys.argv[1]
    validate_pdf(pdf_file)

    print("[*] Starting PDF Malware Analysis")
    print("[*] Static analysis mode enabled\n")

    results = {}

    print("[+] Analyzing metadata and suspicious keywords")
    results["metadata"] = analyze_metadata(pdf_file)

    print("[+] Analyzing PDF object structure")
    results["objects"] = analyze_objects(pdf_file)

    print("[+] Inspecting embedded JavaScript")
    results["javascript"] = analyze_javascript(pdf_file)

    print("[+] Extracting readable strings")
    results["strings"] = extract_strings(pdf_file)

    report_file = generate_report(pdf_file, results)

    print("\n[+] Analysis completed successfully")
    print(f"[+] Report generated: {report_file}")


if __name__ == "__main__":
    main()
